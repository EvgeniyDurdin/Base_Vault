### 3.3.1 EXCLUDE
Как мы выяснили на предыдущих уроках, фреймы бывают трех типов: строковые, групповые и диапазонные. Теперь определение фрейма выглядит так:
```sql
{ ROWS | GROUPS | RANGE } BETWEEN frame_start AND frame_end
```
Обычно этого достаточно. Но иногда хочется исключить из фрейма часть записей.
Продолжим использовать табличку `employees`:
```sql
┌────┬──────────┬────────┬────────────┬────────┐
│ id │   name   │  city  │ department │ salary │
├────┼──────────┼────────┼────────────┼────────┤
│ 11 │ Дарья    │ Самара │ hr         │ 70     │
│ 12 │ Борис    │ Самара │ hr         │ 78     │
│ 21 │ Елена    │ Самара │ it         │ 84     │
│ 22 │ Ксения   │ Москва │ it         │ 90     │
│ 23 │ Леонид   │ Самара │ it         │ 104    │
│ 24 │ Марина   │ Москва │ it         │ 104    │
│ 25 │ Иван     │ Москва │ it         │ 120    │
│ 31 │ Вероника │ Москва │ sales      │ 96     │
│ 32 │ Григорий │ Самара │ sales      │ 96     │
│ 33 │ Анна     │ Москва │ sales      │ 100    │
└────┴──────────┴────────┴────────────┴────────┘
```
Допустим, мы хотим понять, как изменится средняя зарплата по организации, если уволить того или иного сотрудника. Как посчитать среднюю зарплату, мы знаем:
```sql
select
  name, salary,
  round(avg(salary) over w) as "avg"
from employees
window w as ()
order by salary, id;

┌──────────┬────────┬──────┐
│   name   │ salary │ avg  │
├──────────┼────────┼──────┤
│ Дарья    │ 70     │ 94.0 │
│ Борис    │ 78     │ 94.0 │
│ Елена    │ 84     │ 94.0 │
│ Ксения   │ 90     │ 94.0 │
│ Вероника │ 96     │ 94.0 │
│ Григорий │ 96     │ 94.0 │
│ Анна     │ 100    │ 94.0 │
│ Леонид   │ 104    │ 94.0 │
│ Марина   │ 104    │ 94.0 │
│ Иван     │ 120    │ 94.0 │
└──────────┴────────┴──────┘
```
Но как теперь для каждого сотрудника посчитать среднее, исключая его самого?
Для начала перепишем определение окна с явным указанием фрейма:
```sql
window w as (
  rows between unbounded preceding and unbounded following
)
```
А теперь исключим из фрейма текущую запись с помощью инструкции `EXCLUDE`:
```sql
window w as (
  rows between unbounded preceding and unbounded following
  exclude current row
)
```
Вот как поменялась ситуация на примере Вероники:
![[Stepic_Wnd_3.3.1.png]]
Теперь фрейм включает все записи, кроме текущей. А функция `avg()` считает среднюю зарплату для всех коллег сотрудника, исключая его самого. Ровно то, что нам нужно!
Запрос целиком и результат:
```sql
select
  name, salary,
  round(avg(salary) over w) as "avg"
from employees
window w as (
  rows between unbounded preceding and unbounded following
  exclude current row
)
order by salary, id;

┌──────────┬────────┬──────┐
│   name   │ salary │ avg  │
├──────────┼────────┼──────┤
│ Дарья    │ 70     │ 97.0 │
│ Борис    │ 78     │ 96.0 │
│ Елена    │ 84     │ 95.0 │
│ Ксения   │ 90     │ 95.0 │
│ Вероника │ 96     │ 94.0 │
│ Григорий │ 96     │ 94.0 │
│ Анна     │ 100    │ 94.0 │
│ Леонид   │ 104    │ 93.0 │
│ Марина   │ 104    │ 93.0 │
│ Иван     │ 120    │ 91.0 │
└──────────┴────────┴──────┘
```
`EXCLUDE` поддерживается в PostgreSQL, SQLite и Oracle 21c+, но не в MySQL и SQL Server.

### 3.3.2 Виды исключений
Стандарт SQL предусматривает четыре разновидности EXCLUDE:
- EXCLUDE NO OTHERS. Ничего не исключать. Вариант по умолчанию: если явно не указать exclude, сработает именно он.
- EXCLUDE CURRENT ROW. Исключить текущую запись (как мы сделали на предыдущем шаге с сотрудником).
- EXCLUDE GROUP. Исключить текущую запись и все равные ей (по значению столбцов из order by).
- EXCLUDE TIES. Оставить текущую запись, но исключить равные ей.
На примере Вероники (окно отсортировано по зарплате):
![[Stepic_Wnd_3.3.2.png]]
**EXCLUDE GROUP / TIES**
Вернемся к запросу о средней зарплате. Вариант с `exclude current row` отвечал на вопрос:
> Как изменится средняя зарплата по организации, если уволить конкретного сотрудника?
```sql
-- exclude current row
┌────┬──────────┬────────┬──────┬────────────────────────────────────┬─────┐
│ id │   name   │ salary │ avg  │               frame                │ exc │
├────┼──────────┼────────┼──────┼────────────────────────────────────┼─────┤
│ 11 │ Дарья    │ 70     │ 97.0 │ 12, 21, 22, 31, 32, 33, 23, 24, 25 │ 11  │
│ 12 │ Борис    │ 78     │ 96.0 │ 11, 21, 22, 31, 32, 33, 23, 24, 25 │ 12  │
│ 21 │ Елена    │ 84     │ 95.0 │ 11, 12, 22, 31, 32, 33, 23, 24, 25 │ 21  │
│ 22 │ Ксения   │ 90     │ 95.0 │ 11, 12, 21, 31, 32, 33, 23, 24, 25 │ 22  │
│ 31 │ Вероника │ 96     │ 94.0 │ 11, 12, 21, 22, 32, 33, 23, 24, 25 │ 31  │
│ 32 │ Григорий │ 96     │ 94.0 │ 11, 12, 21, 22, 31, 33, 23, 24, 25 │ 32  │
│ 33 │ Анна     │ 100    │ 94.0 │ 11, 12, 21, 22, 31, 32, 23, 24, 25 │ 33  │
│ 23 │ Леонид   │ 104    │ 93.0 │ 11, 12, 21, 22, 31, 32, 33, 24, 25 │ 23  │
│ 24 │ Марина   │ 104    │ 93.0 │ 11, 12, 21, 22, 31, 32, 33, 23, 25 │ 24  │
│ 25 │ Иван     │ 120    │ 91.0 │ 11, 12, 21, 22, 31, 32, 33, 23, 24 │ 25  │
└────┴──────────┴────────┴──────┴────────────────────────────────────┴─────┘
```
- столбец `frame` показывает содержимое фрейма для каждой записи;
- столбец `exc` показывает, кого исключили.
Если использовать `exclude group` — получим ответ на вопрос:
> Как изменится средняя зарплата по организации, если уволить конкретного сотрудника и всех, кто получает столько же, сколько и он?
```sql
-- exclude group
┌────┬──────────┬────────┬──────┬────────────────────────────────────┬────────┐
│ id │   name   │ salary │ avg  │               frame                │  exc   │
├────┼──────────┼────────┼──────┼────────────────────────────────────┼────────┤
│ 11 │ Дарья    │ 70     │ 97.0 │ 12, 21, 22, 31, 32, 33, 23, 24, 25 │ 11     │
│ 12 │ Борис    │ 78     │ 96.0 │ 11, 21, 22, 31, 32, 33, 23, 24, 25 │ 12     │
│ 21 │ Елена    │ 84     │ 95.0 │ 11, 12, 22, 31, 32, 33, 23, 24, 25 │ 21     │
│ 22 │ Ксения   │ 90     │ 95.0 │ 11, 12, 21, 31, 32, 33, 23, 24, 25 │ 22     │
│ 31 │ Вероника │ 96     │ 94.0 │ 11, 12, 21, 22, 33, 23, 24, 25     │ 31, 32 │
│ 32 │ Григорий │ 96     │ 94.0 │ 11, 12, 21, 22, 33, 23, 24, 25     │ 31, 32 │
│ 33 │ Анна     │ 100    │ 94.0 │ 11, 12, 21, 22, 31, 32, 23, 24, 25 │ 33     │
│ 23 │ Леонид   │ 104    │ 92.0 │ 11, 12, 21, 22, 31, 32, 33, 25     │ 23, 24 │
│ 24 │ Марина   │ 104    │ 92.0 │ 11, 12, 21, 22, 31, 32, 33, 25     │ 23, 24 │
│ 25 │ Иван     │ 120    │ 91.0 │ 11, 12, 21, 22, 31, 32, 33, 23, 24 │ 25     │
└────┴──────────┴────────┴──────┴────────────────────────────────────┴────────┘
```
Если же использовать `exclude ties` — получим ответ на вопрос:
> Как изменится средняя зарплата по организации, если уволить всех, кто получает столько же, сколько конкретный сотрудник, но не увольнять его самого?
```sql
-- exclude ties
┌────┬──────────┬────────┬──────┬────────────────────────────────────────┬─────┐
│ id │   name   │ salary │ avg  │                 frame                  │ exc │
├────┼──────────┼────────┼──────┼────────────────────────────────────────┼─────┤
│ 11 │ Дарья    │ 70     │ 94.0 │ 11, 12, 21, 22, 31, 32, 33, 23, 24, 25 │     │
│ 12 │ Борис    │ 78     │ 94.0 │ 11, 12, 21, 22, 31, 32, 33, 23, 24, 25 │     │
│ 21 │ Елена    │ 84     │ 94.0 │ 11, 12, 21, 22, 31, 32, 33, 23, 24, 25 │     │
│ 22 │ Ксения   │ 90     │ 94.0 │ 11, 12, 21, 22, 31, 32, 33, 23, 24, 25 │     │
│ 31 │ Вероника │ 96     │ 94.0 │ 11, 12, 21, 22, 31, 33, 23, 24, 25     │ 32  │
│ 32 │ Григорий │ 96     │ 94.0 │ 11, 12, 21, 22, 32, 33, 23, 24, 25     │ 31  │
│ 33 │ Анна     │ 100    │ 94.0 │ 11, 12, 21, 22, 31, 32, 33, 23, 24, 25 │     │
│ 23 │ Леонид   │ 104    │ 93.0 │ 11, 12, 21, 22, 31, 32, 33, 23, 25     │ 24  │
│ 24 │ Марина   │ 104    │ 93.0 │ 11, 12, 21, 22, 31, 32, 33, 24, 25     │ 23  │
│ 25 │ Иван     │ 120    │ 94.0 │ 11, 12, 21, 22, 31, 32, 33, 23, 24, 25 │     │
└────┴──────────┴────────┴──────┴────────────────────────────────────────┴─────┘
```
**Тип фрейма и вид исключения**
Возможно, вы заметили, что в exclude фигурируют понятия _текущей записи_ (current row) и _группы_ (group). Похожее разделение мы видели в типах фреймов: строковые фреймы оперируют записями (rows), а групповые — группами (groups).
**Но! Исключения и типы фреймов никак между собой не связаны:**
- Какой бы тип фрейма вы не использовали (rows, groups, range) — `exclude current row` исключает только текущую запись, не группу.
- Какой бы тип фрейма вы не использовали — `exclude group` исключает всю группу.