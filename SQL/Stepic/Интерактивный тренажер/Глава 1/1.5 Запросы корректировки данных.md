## Добавление записей в таблицу
Добавление одной записи в таблицу осуществляется с помощью запроса `INSERT`, подробно рассмотренного в [[1.1 Основы реляционной модели и SQL]]. Запросы обязательно разделять точкой с запятой.
Допускается вставка нескольких записей одновременно, для этого используется SQL запрос следующего вида:
```sql
INSERT INTO имя_таблицы(столбец_1, столбец_2, ..., столбец_N)
VALUES
    (значение_1_1, значение_1_2, ..., значение_1_N),
    (значение_2_1, значение_2_2, ..., значение_2_N),
    ...
    (значение_M_1, значение_M_2, ..., значение_M_N);
```
Например, чтобы добавить в таблицу **book** две новые записи используется запрос:
```sql
INSERT INTO book (title, author, price, amount) 
VALUES 
    ('Война и мир','Толстой Л.Н.', 1070.20, 2),
    ('Анна Каренина', 'Толстой Л.Н.', 599.90, 3);
```


## Добавление записей из другой таблицы
С помощью запроса на добавление можно не только добавить в таблицу конкретные значения (список `VALUES`), но и записи из другой таблицы, отобранные с помощью запроса на выборку.  В этом случае вместо раздела `VALUES` записывается запрос на выборку, начинающийся с `SELECT`.  В нем можно использовать `WHERE, GROUP BY, ORDER BY`.
Правила соответствия между полями таблицы и вставляемыми значениями из запроса:
1.  количество полей в таблице и количество полей в запросе должны совпадать;
2.  должно существовать прямое соответствие между позицией одного и того же элемента в обоих списках, поэтому первый столбец запроса должен относиться к первому столбцу в списке столбцов таблицы, второй – ко второму столбцу и т.д.
3.   типы столбцов запроса должны быть совместимы с типами данных соответствующих столбцов таблицы ( целое число можно занести в поле типа `DECIMAL`, обратная операция – недопустима).
**Пример**
Занести все книги из таблицы **supply** в таблицу **book**.
_Запрос:_
```sql
INSERT INTO book (title, author, price, amount) 
SELECT title, author, price, amount 
FROM supply;

SELECT * FROM book;
```
_Результат:_
```sql
Affected rows: 4
Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       | Лирика                | Пастернак Б.Л.   | 518.99 | 2      |
| 7       | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 8       | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 9       | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
+---------+-----------------------+------------------+--------+--------+
Affected rows: 9
```
С помощью этого запроса в таблицу **book** включены все книги из **supply**, даже те, которые в **book** уже есть («Белая гвардия» и «Идиот»). В результате в таблице одна и та же книга, например «Белая гвардия», имеет код 2 и 8. Для реляционной модели это нежелательная ситуация. 


## Добавление записей, вложенные запросы
В запросах на добавление можно использовать вложенные запросы.
**Пример**
Занести из таблицы **supply** в таблицу **book** только те книги, названия которых отсутствуют в таблице **book.**
_Запрос:_
```sql
INSERT INTO book (title, author, price, amount) 
SELECT title, author, price, amount 
FROM supply
WHERE title NOT IN (
        SELECT title 
        FROM book
      );

SELECT * FROM book;
```
_Результат:_
```sql
Affected rows: 2

Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       | Лирика                | Пастернак Б.Л.   | 518.99 | 2      |
| 7       | Черный человек        | Есенин С.А.      | 570.20 | 6      |
+---------+-----------------------+------------------+--------+--------+
```
Вложенным запросом отбираются все названия книг, которые есть в таблице **book**. Основным запросом `SELECT` из таблицы **supply** выбираются книги, названия которых нет в результате вложенного запроса. Отобранные записи добавляются в конец таблицы **book**запросом на добавление `INSERT`.


## Запросы на обновление
Под обновлением данных подразумевается изменение значений в существующих записях таблицы. При этом возможно как изменение значений полей в группе строк (даже всех строк таблицы), так и правка значения поля отдельной строки.
Изменение записей в таблице реализуется с помощью запроса `UPDATE`. Простейший запрос на обновление выглядит так:
```sql
UPDATE таблица SET поле = выражение
```
где   
**таблица** – имя таблицы, в которой будут проводиться изменения;  
**поле** – поле таблицы, в которое будет внесено изменение;  
**выражение** – выражение,  значение которого будет занесено в поле.
**Пример**
Уменьшить на 30% цену книг в таблице **book**.
_Запрос:_
```sql
UPDATE book 
SET price = 0.7 * price;

SELECT * FROM book;
```
_Результат:_
```sql
Affected rows: 5
Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 469.69 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 378.35 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 322.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 559.31 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 455.00 | 15     |
+---------+-----------------------+------------------+--------+--------+
```
С помощью запросов на обновление можно изменять не все записи в таблице (как в предыдущем запросе), а только часть из них. Для этого в запрос включается ключевое слово `WHERE`, после которого указывается условие отбора строк для изменения.
**Пример**
Уменьшить на 30% цену тех книг в таблице **book**, количество которых меньше 5.
_Запрос:_
```sql
UPDATE book 
SET price = 0.7 * price 
WHERE amount < 5;

SELECT * FROM book;
```
_Результат:_
```sql
Affected rows: 2
Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 469.69 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 559.31 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+
```
В этом запросе обновляется только 2 записи (цена книг «Мастер и Маргарита» и «Братья Карамазовы»).


## Запросы на обновление нескольких столбцов
Запросом `UPDATE` можно обновлять значения нескольких столбцов одновременно. В этом случае простейший запрос будет выглядеть так:
```sql
UPDATE таблица SET поле1 = выражение1, поле2 = выражение2
```
На складе, кроме хранения и получения книг, выполняется их оптовая продажа. Для реализации этого действия включим дополнительный столбец **buy**  в таблицу **book**:
**Пример**
В столбце **buy** покупатель указывает количество книг, которые он хочет приобрести. Для каждой книги, выбранной покупателем, необходимо уменьшить ее количество на складе на указанное в столбце **buy** количество, а в столбец **buy** занести 0.
_Запрос:_
```sql
UPDATE book 
SET amount = amount - buy,
    buy = 0;

SELECT * FROM book;
```
_Результат:_
```sql
Affected rows: 3
Query result:
+---------+-----------------------+------------------+--------+--------+-----+
| book_id | title                 | author           | price  | amount | buy |
+---------+-----------------------+------------------+--------+--------+-----+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      | 0   |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 2      | 0   |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 2      | 0   |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      | 0   |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | -3     | 0   |
+---------+-----------------------+------------------+--------+--------+-----+
```
Как видно из таблицы, без проверки данных, которые занесены в столбец,  нельзя запускать запрос на обновление (может получиться отрицательное значение количества).
Для реализации этого запроса можно  использовать функцию `IF`.  Синтаксис раздела `SET` при использовании функции **`if()`** следующий:
```
SET столбец = IF(условие, выражение_1, выражение_2)
```
Выполняется этот оператор так:
-   сначала вычисляется `условие`;
-   если условие ИСТИНА, то вычисляется `выражение_1`, в противном случае (если условие ЛОЖНО) вычисляется `выражение_2`;
-   в столбец заносится результат выполнения функции (либо значение `выражения_1`, либо значение `выражения_2` в зависимости от условия).
Например, для увеличения на 10% только цен книг Булгакова используется запрос:
```sql
UPDATE book 
SET price = IF(author = "Булгаков М.А.", price * 1.1, price);
```


## Запросы на обновление нескольких таблиц 
В запросах на обновление можно использовать несколько таблиц, но тогда
-   для столбцов, имеющих одинаковые имена, необходимо указывать имя таблицы, к которой они относятся, например, **book.price** – столбец **price** из таблицы **book**, **supply.price** – столбец **price** из таблицы **supply**;
-   все таблицы, используемые в запросе, нужно перечислить после ключевого слова `UPDATE`;
-   в запросе обязательно условие `WHERE`, в котором указывается условие при котором обновляются данные.
**Пример**
Если в таблице **supply**  есть те же книги, что и в таблице **book**, добавлять эти книги в таблицу **book** не имеет смысла. Необходимо увеличить их количество на значение столбца **amount**таблицы **supply**.
_Запрос:_
```sql
UPDATE book, supply 
SET book.amount = book.amount + supply.amount
WHERE book.title = supply.title AND book.author = supply.author;

SELECT * FROM book;
```
_Результат:_
```sql
Affected rows: 2
Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 12     |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 13     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+
```
В этом запросе увеличилось количество двух книг: «Белая гвардия», которая в **supply** имеет ту же цену, и «Идиот», но цена этой книги в таблицах **book** и **supply** отличается. Для этой книги нужно пересчитать цену.
Можно использовать вложенный запрос как отдельную таблицу, записанную после ключевого слова `UPDATE`, при этом вложенному запросу необходимо присвоить имя, например **query_in**:
```sql
UPDATE fine, 
    (
     SELECT ...
    ) query_in
SET ...
WHERE указать, что совпадают нарушение, фамилия водителя и номер машины в таблицах fine и вложенном запросе query_in соответственно, а также дата оплаты в таблице fine пуста
```
Другим способом решения является использование двух запросов: сначала создать временную таблицу, например **query_in**, в которую включить информацию о тех штрафах, сумму которых нужно увеличить в два раза, а затем уже обновлять информацию в таблице **fine**:
```sql
CREATE TABLE query_in ...;

UPDATE fine, query_in
SET ...
WHERE ...;
```
После ключевого слова `WHERE` указывается условие, при котором нужно обновлять данные. В нашем случае  данные обновляются, если и фамилия, и государственный номер, и нарушение совпадают в таблице **fine** и в результирующей таблице запроса **query_in**. Например, для связи по фамилии используется запись `fine.name = query_in.name`. 
**Важно!** Если в запросе используется несколько таблиц или запросов, включающих одинаковые поля, то применяется полное имя столбца, включающего название таблицы через символ «**.**». Например,  `fine.name`  и  `query_in.name`.


## Запросы на удаление
Запросы корректировки данных позволяют удалить одну или несколько записей из  таблицы. Простейший запрос на удаление имеет вид:
```sql
DELETE FROM таблица;
```
Этот запрос удаляет все записи из указанной после `FROM` таблицы.
**Пример**
После того, как информация о книгах из таблицы **supply** перенесена в **book** , необходимо очистить таблицу  **supply**.
_Запрос:_
```sql
DELETE FROM supply;

SELECT * FROM supply;
```
_Результат:_
```sql
Affected rows: 4
Affected rows: 0
```
Из таблицы удалены все записи. Запрос на выборку отобрал 0 записей.
Запрос на удаления позволяет удалить не все записи таблицы, а только те, которые удовлетворяют условию, указанному после ключевого слова `WHERE`:
```sql
DELETE FROM таблица
WHERE условие;
```
**Пример**
Удалить из таблицы **supply** все книги, названия которых есть в таблице **book**.
_Запрос:_
```sql
DELETE FROM supply 
WHERE title IN (
        SELECT title 
        FROM book
      );

SELECT * FROM supply;
```
Результат:
```sql
Affected rows: 2

Query result:
+-----------+--------------------------+------------------+--------+--------+
| supply_id | title                    | author           | price  | amount |
+-----------+--------------------------+------------------+--------+--------+
| 1         | Лирика                   | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек           | Есенин С.А.      | 570.20 | 6      |
+-----------+--------------------------+------------------+--------+--------+
```
Из таблицы **supply** удалены две записи о книгах «Белая гвардия» и «Идиот».


## Запросы на создание таблицы
Новая таблица может быть создана на основе данных из другой таблицы. Для этого используется запрос `SELECT`, результирующая таблица которого и будет новой таблицей базы данных. При этом имена столбцов запроса становятся именами столбцов новой таблицы. Запрос на создание новой таблицы имеет вид:
```sql
CREATE TABLE имя_таблицы AS
SELECT ...
```
**Пример**
Создать таблицу заказ (**ordering**), куда включить авторов и названия тех книг, количество экземпляров которых в таблице **book** меньше 4. Для всех книг указать одинаковое количество экземпляров 5.
_Запрос:_
```sql
CREATE TABLE ordering AS
SELECT author, title, 5 AS amount
FROM book
WHERE amount < 4;

SELECT * FROM ordering;
```
_Результат:_
```sql
Affected rows: 2
Query result:
+------------------+--------------------+--------+
| author           | title              | amount |
+------------------+--------------------+--------+
| Булгаков М.А.    | Мастер и Маргарита | 5      |
| Достоевский Ф.М. | Братья Карамазовы  | 5      |
+------------------+--------------------+--------+
```
При создании таблицы можно использовать вложенные запросы как после `SELECT`, так и после `WHERE`.
**Пример**
Создать таблицу заказ (**ordering**), куда включить авторов и названия тех книг, количество экземпляров которых в таблице **book** меньше 4. Для всех книг указать одинаковое значение - среднее количество экземпляров книг в таблице **book**.
_Запрос:_
```sql
CREATE TABLE ordering AS
SELECT author, title, 
   (
    SELECT ROUND(AVG(amount)) 
    FROM book
   ) AS amount
FROM book
WHERE amount < 4;

SELECT * FROM ordering;
```
_Результат:_
```sql
Affected rows: 2
Query result:
+------------------+--------------------+--------+
| author           | title              | amount |
+------------------+--------------------+--------+
| Булгаков М.А.    | Мастер и Маргарита | 7      |
| Достоевский Ф.М. | Братья Карамазовы  | 7      |
+------------------+--------------------+--------+
```